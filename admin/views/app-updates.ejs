<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>App Updates Management - TurboMail Admin</title>
    <link rel="stylesheet" href="/styles.css">
    <style>
        .update-card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid #4CAF50;
        }
        .update-card.active {
            border-left-color: #FF9800;
            background: #2d2d2d;
        }
        .update-card.force {
            border-left-color: #f44336;
        }
        .version-badge {
            background: #4CAF50;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            margin-right: 10px;
        }
        .version-badge.active {
            background: #FF9800;
        }
        .version-badge.force {
            background: #f44336;
        }
        .platform-badge {
            background: #2196F3;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 10px;
            margin-left: 5px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #e0e0e0;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            background: #3a3a3a;
            border: 1px solid #555;
            border-radius: 4px;
            color: #e0e0e0;
        }
        .checkbox-group {
            display: flex;
            gap: 20px;
            margin: 10px 0;
        }
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .btn-activate {
            background: #FF9800;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .btn-delete {
            background: #f44336;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 5px;
        }
        .update-actions {
            margin-top: 10px;
            display: flex;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <nav class="sidebar">
            <div class="logo">
                <h2>üìß TurboMail</h2>
                <p>Admin Panel</p>
            </div>
            <ul class="nav-links">
                <li><a href="/dashboard">üìä Dashboard</a></li>
                <li><a href="/domains">üåê Domains</a></li>
                <li><a href="/api-management">üîë API Management</a></li>
                <li><a href="/ads-management">üì± Ads Management</a></li>
                <li><a href="/app-updates" class="active">üîÑ App Updates</a></li>
                <li><a href="/logout">üö™ Logout</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <div class="header">
                <h1>üîÑ App Updates Management</h1>
                <p>Manage app version updates and force update settings</p>
            </div>

            <% if (success) { %>
                <div class="alert alert-success">
                    <%- success %>
                </div>
            <% } %>

            <% if (error) { %>
                <div class="alert alert-error">
                    <%- error %>
                </div>
            <% } %>

            <!-- Create New Version Form -->
            <div class="card">
                <h3>üìù Create/Update App Version</h3>
                <form action="/app-updates/create" method="POST">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="versionName">Version Name *</label>
                            <input type="text" id="versionName" name="versionName" placeholder="e.g., 1.0.0" required>
                        </div>
                        <div class="form-group">
                            <label for="versionCode">Version Code *</label>
                            <input type="number" id="versionCode" name="versionCode" placeholder="e.g., 1" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="platform">Platform</label>
                        <select id="platform" name="platform">
                            <option value="android">Android</option>
                            <option value="ios">iOS</option>
                            <option value="both">Both</option>
                        </select>
                    </div>

                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="isForceUpdate" name="isForceUpdate" value="true">
                            <label for="isForceUpdate">Force Update</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="isNormalUpdate" name="isNormalUpdate" value="true">
                            <label for="isNormalUpdate">Normal Update</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="isActive" name="isActive" value="true">
                            <label for="isActive">Set as Active</label>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="updateMessage">Update Message</label>
                        <textarea id="updateMessage" name="updateMessage" rows="3" placeholder="What's new in this version..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="updateLink">Update Link</label>
                        <input type="url" id="updateLink" name="updateLink" placeholder="https://play.google.com/store/apps/details?id=...">
                    </div>

                    <button type="submit" class="btn btn-primary">üíæ Create/Update Version</button>
                </form>
            </div>

            <!-- Active Version Info -->
            <% if (activeUpdate) { %>
            <div class="card">
                <h3>üéØ Currently Active Version</h3>
                <div class="update-card active">
                    <div style="display: flex; justify-content: between; align-items: center;">
                        <div>
                            <span class="version-badge active">v<%= activeUpdate.versionName %></span>
                            <strong>Code: <%= activeUpdate.versionCode %></strong>
                            <span class="platform-badge"><%= activeUpdate.platform.toUpperCase() %></span>
                            <% if (activeUpdate.isForceUpdate) { %>
                                <span class="version-badge force">FORCE UPDATE</span>
                            <% } %>
                            <% if (activeUpdate.isNormalUpdate) { %>
                                <span class="version-badge">NORMAL UPDATE</span>
                            <% } %>
                        </div>
                    </div>
                    <% if (activeUpdate.updateMessage) { %>
                        <p style="margin: 10px 0; color: #ccc;"><%= activeUpdate.updateMessage %></p>
                    <% } %>
                    <% if (activeUpdate.updateLink) { %>
                        <p style="margin: 5px 0;"><strong>Update Link:</strong> <a href="<%= activeUpdate.updateLink %>" target="_blank" style="color: #4CAF50;"><%= activeUpdate.updateLink %></a></p>
                    <% } %>
                    <p style="margin: 5px 0; font-size: 12px; color: #888;">Created: <%= new Date(activeUpdate.createdAt).toLocaleString() %></p>
                </div>
            </div>
            <% } %>

            <!-- All Versions List -->
            <div class="card">
                <h3>üìã All App Versions</h3>
                <% if (updates && updates.length > 0) { %>
                    <% updates.forEach(update => { %>
                        <div class="update-card <%= update.isActive ? 'active' : '' %> <%= update.isForceUpdate ? 'force' : '' %>">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <span class="version-badge <%= update.isActive ? 'active' : '' %> <%= update.isForceUpdate ? 'force' : '' %>">
                                        v<%= update.versionName %>
                                    </span>
                                    <strong>Code: <%= update.versionCode %></strong>
                                    <span class="platform-badge"><%= update.platform.toUpperCase() %></span>
                                    <% if (update.isForceUpdate) { %>
                                        <span class="version-badge force">FORCE</span>
                                    <% } %>
                                    <% if (update.isNormalUpdate) { %>
                                        <span class="version-badge">NORMAL</span>
                                    <% } %>
                                    <% if (update.isActive) { %>
                                        <span class="version-badge active">ACTIVE</span>
                                    <% } %>
                                </div>
                                <div class="update-actions">
                                    <% if (!update.isActive) { %>
                                        <form action="/app-updates/activate/<%= update.versionCode %>" method="POST" style="display: inline;">
                                            <button type="submit" class="btn-activate">üéØ Activate</button>
                                        </form>
                                    <% } %>
                                    <button onclick="deleteVersion('<%= update.versionCode %>')" class="btn-delete">üóëÔ∏è Delete</button>
                                </div>
                            </div>
                            <% if (update.updateMessage) { %>
                                <p style="margin: 10px 0; color: #ccc;"><%= update.updateMessage %></p>
                            <% } %>
                            <% if (update.updateLink) { %>
                                <p style="margin: 5px 0; font-size: 12px;"><strong>Link:</strong> <a href="<%= update.updateLink %>" target="_blank" style="color: #4CAF50;"><%= update.updateLink %></a></p>
                            <% } %>
                            <p style="margin: 5px 0; font-size: 12px; color: #888;">
                                Created: <%= new Date(update.createdAt).toLocaleString() %> | 
                                Updated: <%= new Date(update.updatedAt).toLocaleString() %>
                            </p>
                        </div>
                    <% }) %>
                <% } else { %>
                    <div class="empty-state">
                        <p>üì± No app versions found. Create your first version above.</p>
                    </div>
                <% } %>
            </div>

            <!-- API Information -->
            <div class="card">
                <h3>üîó API Endpoints for Flutter App</h3>
                <div class="api-info">
                    <div class="api-endpoint">
                        <strong>Get Active Update:</strong>
                        <code>GET /api/app-updates?platform=android</code>
                        <p>Returns the currently active app update for the specified platform</p>
                    </div>
                    <div class="api-endpoint">
                        <strong>Get Ads Config:</strong>
                        <code>GET /api/ads-config</code>
                        <p>Returns all ads configuration for the Flutter app</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        async function deleteVersion(versionCode) {
            if (confirm(`Are you sure you want to delete version ${versionCode}?`)) {
                try {
                    const response = await fetch(`/app-updates/delete/${versionCode}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        location.reload();
                    } else {
                        const error = await response.json();
                        alert('Error: ' + error.error);
                    }
                } catch (error) {
                    alert('Error deleting version: ' + error.message);
                }
            }
        }

        // Auto-fill version code based on version name
        document.getElementById('versionName').addEventListener('input', function() {
            const versionName = this.value;
            const versionCodeInput = document.getElementById('versionCode');
            
            if (versionName && !versionCodeInput.value) {
                // Simple logic to generate version code from version name
                const parts = versionName.split('.');
                if (parts.length >= 2) {
                    const major = parseInt(parts[0]) || 0;
                    const minor = parseInt(parts[1]) || 0;
                    const patch = parseInt(parts[2]) || 0;
                    const versionCode = major * 10000 + minor * 100 + patch;
                    versionCodeInput.value = versionCode;
                }
            }
        });
    </script>
</body>
</html>